https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0071.Git%20%EB%B0%B0%ED%8F%AC%EC%8B%A4%EC%8A%B5/021.vault%EC%99%80%20db%20admin.md

### 멀티 티어 환경의 보안 강화: Ansible Vault 및 DB 계정 관리 체계

인프라의 보안을 위해 민감한 정보(DB 비밀번호 등)를 **Ansible Vault**로 암호화하고, DB 서버에 관리자(`admin`) 계정을 생성하는 절차를 추가합니다. 이 과정은 보안상 매우 중요하며, GitHub에는 암호화된 파일만 업로드됩니다.

---

## 1. 멀티 티어 프로젝트 디렉토리 구조

base60으로 디코딩하면 바로 암호 나오니까 항상 변수로 줘야 함
깃허브에는 vault 파일은 올리면 안 됨=git ignore로 등록해야 함

git ignore은 리포지토리 만들 때 일단 바로 만들어야 함

git은 버전 관리하는 것 한번이라도 커밋하면 git ignore에 넣어도 보호가 안 됨(vault파일은 처음부터 git ignore에 넣어놔야 함)  
add . 으로 최초에 한번 커밋 되어버리면 vault파일이 한번 커밋이 됐다면 git rm --cached <디렉토리경로>와 같은 방식으로 보호 상태로 돌려놔야 함
하지만 DB접속하는 웹서버들도 써야 해서 git cached를 했어도 이미 다운 받은 사람은 이전에 다운받아져 있는 vault파일이 안지워짐.
하지만 그 후에 git pull하면 다시 vault파일도 지워짐( git cached로 버전 관리하지 않겠다고 선언했기 때문에)

보안 관련 파일(`.vault_pass`, 암호화된 변수 파일)이 추가된 구조입니다.

```text
[인프라 관리 저장소: web_dep]
~/projects/web_dep/
├── .gitignore              # .vault_pass, inventory.ini 포함
├── .vault_pass             # [내 PC] Vault 암호 해독용 키 파일
├── group_vars/
│   └── all/
│       └── secret.yml      # [GitHub] 암호화된 DB 비밀번호 변수
├── inventory.ini           # [내 PC] 웹/DB 서버 IP 정의
├── web_dep.yml             # [내 PC] 실행 지시서
└── deploy_logic.yml        # [GitHub] 통합 배포 로직 (Nginx + MySQL + Admin)

```

---

## 2. [내 PC] Ansible Vault 설정 및 변수 암호화

민감한 DB 관리자 비밀번호를 GitHub에 평문으로 올리지 않기 위해 암호화 과정을 먼저 수행합니다.

```bash
# 1. Vault 비밀번호 파일 생성 (내 PC에만 보관, .gitignore 필수)
echo "my_secure_password" > .vault_pass
chmod 600 .vault_pass

# 2. 암호화된 변수 파일 생성
# 아래 명령 실행 후 편집기에서 db_admin_password: "진짜비밀번호" 입력
ansible-vault create group_vars/all/secret.yml --vault-password-file .vault_pass

# (나중에 수정할 때)
# ansible-vault edit group_vars/all/secret.yml --vault-password-file .vault_pass

```

---

## 3. [GitHub] 통합 배포 로직 (`deploy_logic.yml`)

DB 서버에 MySQL을 설치하고, Vault에서 복호화된 변수를 사용하여 `admin` 계정을 생성하는 단계를 추가합니다.

**`deploy_logic.yml` (GitHub 업로드)**

```yaml
---
# 1. DB 서버 설정 및 관리자 계정 생성
- name: Database Server Setup with Security
  hosts: dbservers
  become: true
  tasks:
    - name: 1. MySQL 설치
      apt:
        name: 
          - mysql-server
          - python3-pymysql  # Ansible에서 MySQL 관리를 위해 필요
        state: present
        update_cache: yes

    - name: 2. MySQL 서비스 시작
      service:
        name: mysql
        state: started
        enabled: yes

    - name: 3. DB 관리자(admin) 계정 생성
      # Vault에서 암호화된 db_admin_password 변수를 사용합니다.
      mysql_user:
        name: admin
        password: "{{ db_admin_password }}"
        priv: "*.*:ALL,GRANT"
        host: "%"  # 모든 호스트에서 접속 허용 (실무에선 웹서버 IP 대역 권장)
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

# 2. 웹 서버 설정 (사용자 정의 경로 ~/web_project)
- name: Web Server Setup
  hosts: webservers
  become: true
  tasks:
    - name: 1. Nginx 설치
      apt:
        name: nginx
        state: present

    - name: 2. 서비스용 디렉토리 생성
      file:
        path: /home/ubuntu/web_project
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: 3. 개발팀 저장소(web_dev) 소스 배포
      git:
        repo: "https://github.com/사용자계정/web_dev.git"
        dest: "/home/ubuntu/web_project"
        version: main
        force: yes

```

---

## 4. [내 PC] 배포 실행

실행 시 반드시 `.vault_pass` 파일을 참조하도록 설정하여 자동 해독이 가능하게 합니다.

**`web_dep.yml` (내 PC 보관)**

```yaml
---
- name: Vault 보안 적용 통합 배포 트리거
  import_playbook: deploy_logic.yml

```

**실행 명령**

```bash
# --vault-password-file 옵션으로 암호화된 파일을 실시간 해독하며 배포
ansible-playbook -i inventory.ini web_dep.yml --vault-password-file .vault_pass

```

---

## 5. AWS 관련 비용 및 보안 주의사항

* **AWS 인스턴스 자원 관리**: 웹 10대, DB 3대(총 13대) 실습 시 **Free Tier** 무료 시간이 매우 빠르게 소진됩니다. 실습 후에는 반드시 **인스턴스 종료(Terminate)**를 수행하세요.
* **MySQL 유료 전환 주의**: EC2에 직접 설치하는 방식은 무료이나, AWS에서 제공하는 Managed 서비스인 **Amazon RDS**를 추가로 생성할 경우 설정에 따라 비용이 즉시 발생할 수 있으니 주의하십시오.
* **Security Group 설정**: DB 서버의 3306 포트는 반드시 웹 서버 그룹의 Private IP 대역에 대해서만 인바운드를 허용하도록 AWS 콘솔에서 설정해야 보안이 유지됩니다.

---

Next Step: Ansible Vault를 활용한 inventory.ini 내 접속 정보 암호화 및 다중 비밀번호 관리

---

Next Step: Ansible Vault 상세 보안 설정 가이드
