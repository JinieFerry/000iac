https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0071.Git%20%EB%B0%B0%ED%8F%AC%EC%8B%A4%EC%8A%B5/018.nginx%EC%88%98%EC%A0%95%EB%B0%B0%ED%8F%AC.md

### 멀티 레포지토리 기반의 GitOps 배포 체계 구축

본 실습은 인프라 관리용 저장소(`web_dep`)와 개발팀 소스 저장소(`web_dev`)를 분리하여 운영하며, 서비스 경로를 기본값(`/var/www/html`)이 아닌 사용자 정의 경로(`~/web_project`)로 변경하여 운영하는 모델을 다룹니다.

---

## 1. 멀티 레포지토리 디렉토리 구조

실습에 사용되는 두 개의 저장소는 각각 독립적인 목적을 가지며 다음과 같이 구성됩니다.

```text
[인프라 관리 저장소: web_dep]             [개발팀 소스 저장소: web_dev]
~/projects/web_dep/                     (GitHub 전용 또는 별도 폴더)
├── .gitignore                          ├── index.html
├── web_dep.yml (내 PC 실행용)            ├── css/
├── deploy_logic.yml (GitHub 로직)       │   └── style.css
└── nginx/                              ├── js/
    └── default.conf (경로 변경 포함)      │   └── main.js
                                        └── images/
                                            └── logo.png

```

---

## 2. [내 PC] 프로젝트 초기화 및 보안 설정

관리자 PC의 `web_dep` 디렉토리에서 작업을 시작하며, 민감한 정보가 외부로 유출되지 않도록 설정합니다.

```bash
# 1. 작업 디렉토리 생성 및 이동
mkdir -p ~/projects/web_dep
cd ~/projects/web_dep

# 2. Git 저장소 초기화
git init

# 3. 보안을 위한 .gitignore 작성
cat <<EOT > .gitignore
inventory.ini
*.pem
*.key
.vault_pass
EOT

# 4. 설정 반영
git add .gitignore
git commit -m "Initial commit: Set infra project environment"

```

---

## 3. [GitHub] Nginx 사용자 정의 경로 설정 (`nginx/default.conf`)

서비스 홈 디렉토리를 `/var/www/html`에서 `/home/ubuntu/web_project`로 변경하는 설정을 작성합니다.

**`nginx/default.conf` (GitHub `web_dep` 저장소 업로드)**

```nginx
server {
    listen 80;
    server_name localhost;

    # 서비스 홈 경로를 ~/web_project로 변경
    root /home/ubuntu/web_project;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}

```

---

## 4. [GitHub] 중앙 집중형 통합 배포 로직 (`web_dep`)

사용자 정의 디렉토리를 생성하고 권한을 설정한 뒤, Nginx 설정과 소스 코드를 배포합니다.

**`deploy_logic.yml` (GitHub `web_dep` 저장소 업로드)**

```yaml
---
- name: 멀티 레포지토리 기반 통합 배포 (사용자 정의 경로)
  hosts: webservers
  become: true
  tasks:
    - name: 1. Nginx 설치
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: 2. 서비스용 디렉토리 생성 (~/web_project)
      file:
        path: /home/ubuntu/web_project
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: 3. 인프라 저장소(web_dep) 임시 클론
      git:
        repo: "https://github.com/사용자계정/web_dep.git"
        dest: "/tmp/infra_setup"
        version: main
        force: yes

    - name: 4. 변경된 Nginx 설정 적용 (root 경로 수정본)
      copy:
        src: "/tmp/infra_setup/nginx/default.conf"
        dest: "/etc/nginx/sites-available/default"
        remote_src: yes
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx

    - name: 5. 개발팀 저장소(web_dev) 소스를 새 경로로 배포
      git:
        repo: "https://github.com/사용자계정/web_dev.git"
        dest: "/home/ubuntu/web_project"
        version: main
        force: yes

    - name: 6. 임시 디렉토리 정리
      file:
        path: "/tmp/infra_setup"
        state: absent

  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded

```

---

## 5. [내 PC] 배포 실행 및 결과 확인

내 PC의 `web_dep.yml`은 GitHub에 최종 커밋된 `deploy_logic.yml`을 참조하여 실행됩니다.

**`web_dep.yml` (내 PC 보관)**

```yaml
---
- name: GitHub 최신 커밋본 기반 통합 배포 트리거
  import_playbook: deploy_logic.yml

```

**실행 명령**

```bash
ansible-playbook -i inventory.ini web_dep.yml

```

---

## 6. AWS 관련 비용 및 보안 주의사항

* **AWS EC2 인스턴스 종료**: 10대의 서버(`101~110`) 실습 시, **Free Tier** 무료 제공 시간은 약 **3일(75시간)**이면 소진됩니다. 실습 직후에는 반드시 인스턴스를 **종료(Terminate)** 하십시오.
* **디렉토리 권한 주의**: `~/web_project`가 `/home/ubuntu` 하위에 있으므로, Nginx 프로세스(`www-data`)가 해당 경로에 접근할 수 있도록 상위 디렉토리에 실행 권한(`+x`)이 있어야 합니다.
* **보안 그룹**: 인스턴스 보안 그룹에서 **80(HTTP)** 포트와 **22(SSH)** 포트가 적절히 허용되어 있는지 확인하세요.

---

Next Step: Nginx 프로세스 권한과 사용자 정의 디렉토리 간의 퍼미션 문제 해결 실습

---

Next Step: Nginx 권한 설정 상세 가이드
