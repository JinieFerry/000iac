## GitOps 기반 인프라 엔진 및 설정 통합 자동 배포

Nginx 설치 단계(Task 1)마저 GitHub에 정의된 스크립트로 관리하면, 향후 Apache, Lighttpd 등 다른 웹 엔진으로 교체할 때 내 PC의 코드를 수정할 필요 없이 GitHub의 설정 파일만 변경하여 모든 서버에 일괄 적용할 수 있습니다.

---

## 1. 프로젝트 구조 (완전한 중앙 집중형)

모든 설치 로직과 엔진 설정이 GitHub 저장소(`web_dep`)에 집중됩니다. 내 PC에서는 오직 배포를 시작하는 트리거 파일만 존재하게 됩니다.

```text
~/projects/web_dep/
├── web_dep.yml          # [내 PC] 전체 배포 프로세스를 시작하는 실행 트리거
├── deploy_logic.yml     # [GitHub] 실제 서버 구성 태스크 (설치 + 설정 + 배포)
├── .gitignore           # [GitHub] 불필요한 파일 제외 설정
├── setup/               # [GitHub] 엔진 설치 관련 스크립트 폴더
│   └── install_engine.sh # 웹 엔진 설치 스크립트 (Nginx, Apache 등 교체 가능)
├── nginx/               # [GitHub] 엔진 상세 설정 폴더
│   └── default.conf     # Nginx 가상 호스트 설정 파일
└── webdev/              # [GitHub] 실제 서비스 소스 폴더
    └── index.html       # 웹 서비스 메인 페이지

```

---

## 2. [내 PC] 배포 실행 트리거: `web_dep.yml`

이 파일은 각 서버에 접속하여 GitHub의 최신 자산을 내려받고, 저장소 내부에 정의된 로직을 호출하는 관문 역할을 합니다.

```yaml
---
# 1. 인벤토리에 정의된 대상 서버 그룹 지정
- name: GitOps 기반 통합 배포 프로세스 시작
  hosts: webservers
  # 2. 패키지 설치 및 설정 변경을 위한 관리자(sudo) 권한 활성화
  become: true

  tasks:
    # 3. GitHub에서 최신 구성 로직과 설정 파일을 타겟 서버로 클론
    - name: GitHub로부터 최신 배포 자산 동기화
      git:
        # 실제 관리하는 GitHub 저장소 URL로 대체
        repo: "https://github.com/사용자계정/web_dep.git"
        # 모든 서버의 동일한 임시 작업 경로 지정
        dest: "/tmp/web_dep_final"
        # 배포할 브랜치명 명시
        version: main
        # 기존 파일이 존재할 경우 강제로 덮어쓰기 (업데이트)
        force: yes

    # 4. GitHub 저장소 내부에 포함된 상세 배포 로직(deploy_logic.yml) 실행
    # 이 구조를 통해 내 PC의 코드를 수정하지 않고 GitHub의 로직 수정만으로 배포 제어 가능
    - name: 원격 로직(deploy_logic.yml) 실행
      include_tasks: "/tmp/web_dep_final/deploy_logic.yml"

    # 5. 보안 및 공간 확보를 위해 배포 완료 후 임시 디렉토리 제거
    - name: 배포 완료 후 임시 파일 정리
      file:
        path: "/tmp/web_dep_final"
        state: absent #absent=부재하다:안쓰면 (없으면)정리해라

```

---

## 3. [GitHub] 웹 엔진 및 서비스 통합 로직: `deploy_logic.yml`

내 PC의 `web_dep.yml`에 의해 호출되어 실제 작업을 수행하는 핵심 파일입니다.

```yaml
---
# 1. GitHub 내 스크립트를 실행하여 엔진 설치 (엔진 교체 시 스크립트 내용만 변경)
- name: 1. 웹 엔진 설치 (GitHub 내 스크립트 실행)
  shell: "bash /tmp/web_dep_final/setup/install_engine.sh"

# 2. 엔진 설정 파일을 서비스 경로로 복사
- name: 2. 커스텀 엔진 설정 파일 적용
  copy:
    # GitHub에서 클론된 위치의 설정 파일 경로
    src: "/tmp/web_dep_final/nginx/default.conf"
    # 실제 시스템의 설정 파일 경로
    dest: "/etc/nginx/sites-available/default"
    # 타겟 서버 내부 간의 파일 복사임을 명시
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  # 파일 내용 변경 시 하단의 핸들러 호출
  notify: Reload Engine

# 3. 실제 서비스될 웹 콘텐츠 배포
- name: 3. webdev 콘텐츠 배포
  copy:
    src: "/tmp/web_dep_final/webdev/"
    dest: "/var/www/html/"
    remote_src: yes
    owner: www-data #root이고 실행모드여서 실행이 가능함
    group: www-data # 실제 소유자 정보 못 접근하게 하려고 root로 바꿔둔 것
    mode: '0644' #테라폼에서 네자리 쓰기 때문에 0붙여서 맞춰줌

# 4. 설정 변경 시 엔진을 안전하게 재시작하기 위한 핸들러
# (주: include_tasks로 불러온 파일 내에 handlers를 포함하거나 메인 파일에서 관리할 수 있음)

```

---

## 4. [GitHub] 엔진 설치 스크립트: `setup/install_engine.sh`

```bash
#!/bin/bash
# 다른 엔진(예: Apache)으로 교체 시 이 파일의 내용만 수정하여 커밋하면 됩니다.
apt-get update
apt-get install -y nginx

```

---

## 5. AWS 관련 비용 및 보안 주의사항

* **AWS EC2 인스턴스 과금**: 프리티어는 월 750시간을 제공합니다. 하지만 **10대의 인스턴스를 동시 가동하면 약 3일(75시간) 만에 무료 할당량이 소진**됩니다. 실습 완료 후에는 반드시 AWS 콘솔에서 인스턴스를 **종료(Terminate)** 하십시오.
* **탄력적 IP(Elastic IP) 주의**: 인스턴스를 종료하더라도 할당된 Elastic IP를 릴리스(Release)하지 않으면 **시간당 유료 과금**이 발생합니다.
* **쉘 스크립트 권한**: `shell` 모듈 실행 시 권한 오류가 발생할 수 있습니다. `git` 모듈로 가져온 스크립트에 실행 권한(`chmod +x`)이 있는지 확인하거나, 스크립트 내부에 `sudo` 권한이 필요한 명령어를 적절히 배치해야 합니다.

---

Next Step: Ansible Role 모듈화 활용법

---

요청하신 대로 내 PC의 실행 파일(`web_dep.yml`)과 GitHub의 로직 파일(`deploy_logic.yml`)을 명확히 구분하여 통합해 드렸습니다. 모든 행에 주석을 추가하고 디렉토리 구조까지 포함하여 교재 형식에 맞게 구성했습니다. 마지막으로 체크한 결과 모든 설정 사항이 반영되었습니다.

Next Step: Ansible Role 모듈화 활용법
