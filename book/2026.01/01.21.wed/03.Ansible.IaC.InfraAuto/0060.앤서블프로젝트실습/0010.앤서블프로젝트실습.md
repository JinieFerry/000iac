https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0060.%EC%95%A4%EC%84%9C%EB%B8%94%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%8B%A4%EC%8A%B5/0010.%EC%95%A4%EC%84%9C%EB%B8%94%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%8B%A4%EC%8A%B5.md

# 앤서블 실전 프로젝트: 온프레미스 환경을 위한 보안 웹/DB 구축

본 프로젝트는 AWS와 같은 클라우드 방화벽에 의존하지 않고, **서버 자체의 설정만으로 보안을 강화**하는 구성을 다룹니다.

* **웹 서버 (Nginx):** 8080번 포트를 통해 **누구나 외부에서 접속 가능**합니다.
* **데이터베이스 (MariaDB):** 철저하게 **내부(Localhost)**에서만 접속을 허용합니다.
* **Nginx (PHP):** 같은 서버 내부의 로컬 통신으로 DB에 접속합니다.
* **Admin:** 서버 로컬 터미널(SSH)을 통해서만 관리 권한을 행사합니다. (외부 직접 접속 차단)



---

### 1. 프로젝트 디렉토리 구조 (Directory Structure)
handlers디렉토리 만들고 yml파일도 만들어야 해 
roles/에 사실 각각 템플릿이랑 테스크스도 만들어야 해
```text
ansible-project/
├── group_vars/
│   └── all/
│       └── vault.yml        # [보안] 암호화된 비밀번호 저장소
├── roles/
│   ├── common/              # [Role] 패키지 캐시 업데이트 및 기본 유틸
│   ├── mariadb/             # [Role] DB 설치, 로컬 보안 설정, 데이터 주입
│   ├── nginx/               # [Role] 웹서버 설치, 8080 포트 개방, PHP 연동
│   └── webapp/              # [Role] PHP 소스 배포 (DB 연동 페이지)
├── inventory.ini            # 관리 대상 서버 목록 (IP 주소)
├── site.yml                 # 전체 플레이북 실행 파일
└── setup.yml                # (최초 1회용) 디렉토리/파일 자동 생성 스크립트

```

---

### 2. [Step 0] 디렉토리 및 파일 자동 생성 (setup.yml)

수동 생성을 방지하기 위한 스캐폴딩(Scaffolding) 플레이북입니다.

**`setup.yml`**

```yaml
# 실행: ansible-playbook setup.yml
- name: 프로젝트 기초 구조 생성
  hosts: localhost
  connection: local #connection:연결 리모트 컨트롤 하려고 만든게 앤서블 로컬이니까 ssh필요 없음
  gather_facts: no #gather:모은다 facts:host name을 가져와라  상대방을 디폴트로 ssh로 정했음 자기한테 할 때는 
  tasks:
    - name: 롤(Role) 및 변수 디렉토리 생성
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - group_vars/all
        - roles/common/tasks
        - roles/mariadb/tasks
        - roles/mariadb/templates
        - roles/nginx/tasks
        - roles/nginx/templates
        - roles/webapp/tasks
        - roles/webapp/templates

    - name: 빈 파일 생성 (이후 내용을 채워넣음)
      file:
        path: "{{ item }}"
        state: touch
      loop:
        - inventory.ini
        - site.yml
        - group_vars/all/vault.yml
        - roles/common/tasks/main.yml
        - roles/mariadb/tasks/main.yml
        - roles/nginx/tasks/main.yml
        - roles/nginx/templates/default.j2
        - roles/webapp/tasks/main.yml
        - roles/webapp/templates/index.php.j2

```

**[실행 명령어] 반드시 아래 명령어로 구조를 먼저 생성하세요.**

```bash
ansible-playbook setup.yml

```

---

### 3. [Step 1] 비밀번호 암호화 (Ansible Vault)

보안을 위해 비밀번호는 평문으로 저장하지 않습니다.
파일 만들고 시작 위에서 이미 만들었음
1. **Vault 파일 :** `ansible-vault encrypt group_vars/all/vault.yml`
2. `ansible-vault edit group_vars/all/vault.yml`
3. **내용 입력:**

```yaml
# DB 루트(Superuser) 비밀번호
db_root_password: "StrongRootPassword!@#" #복호화가 되면 해시가 아님

# 로컬 관리자(Admin) 비밀번호
db_admin_password: "StrongAdminPassword!@#"

# 웹 애플리케이션(Webapp) 전용 비밀번호
db_web_password: "StrongWebPassword!@#"

```

---

### 4. [Step 2] 역할(Role)별 상세 구현

#### (1) Common Role

**`roles/common/tasks/main.yml`**

```yaml
# 모든 서버에 공통 적용되는 기초 작업
- name: APT 캐시 업데이트 (패키지 설치 에러 방지)
  apt:
    update_cache: yes
    cache_valid_time: 3600

```

#### (2) MariaDB Role (핵심: 로컬 전용 보안 설정)

외부 접속을 원천 차단하고 오직 `localhost` 접속만 허용합니다.

**`roles/mariadb/tasks/main.yml`**

```yaml
- name: MariaDB 및 Python 바인딩 설치
  apt:
    name:
      - mariadb-server
      - python3-pymysql # Ansible이 MySQL을 제어하기 위한 필수 모듈
    state: present

# [중요] 외부 접속 차단 설정
# 127.0.0.1로 설정하면 랜선(외부 IP)을 통한 접속 요청을 아예 듣지 않습니다.
- name: 로컬 접속만 허용 (bind-address = 127.0.0.1)
  lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address' #정규표현식
    line: 'bind-address = 127.0.0.1'
  notify: restart mariadb
                                                                            #노티파이 나오면 handlers해야함 다섯번이면 다 다섯번 핸들러스 작동해도 노티파이는 마지막 한번 만 함 테스크가 다 끝나면 딱 한번 실행함(해당사항이 있을 때만)
                                                                            #restart는 데몬 자체를 다시 시작하는 거 한참 데몬 올라 옴
                                                                            #reload는 환경 변수 바뀐 부분만 적용 (안 끔)

- name: MariaDB 서비스 시작 및 활성화
  service:
    name: mariadb
    state: started          #스타트 유지해라
    enabled: yes            #껐다 켰을 때 자동으로 작동해라

- name: 백업 디렉토리 생성
  # 파일 모듈에는 touch mkdir등 파일 관련 된 모듈 다 들어있음
  file:
    path: /var/lib/mysql/backup
    state: directory
    owner: mysql   #chowner
    group: mysql   #mkgroup
    mode: '0755'   #chmod작동 #특수파일 일 때만 4번째 자리 채우고, 테라폼이 4자리 수 쓰기 때문에 안쓰고 0으로 채워두고, 숫자가 아니라고 ''작따 쳐둠

- name: 로컬의 employees.sql 파일 서버로 복사
  copy:  #카피라는 모듈을 가져올 것
    src: ~/dbbackup/ # 앤서블 실행 PC의 경로 source의 약자 dbbackup전체를 옮겨야 함
    dest: /var/lib/mysql/backup/.
    owner: mysql #mkowner
    group: mysql #mkgroup

# become: yes가 없으면 Root 권한이 없어 DB Import가 실패.
- name: 데이터베이스 주입 (Import)
  community.mysql.mysql_db:    #데이터 주입
    name: employees            #이름
    state: import              #DB에서 쓰는 명령어(^)
    target: /var/lib/mysql/backup/employees.sql
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes


# [보안] 관리자도 오직 로컬(터미널)에서만 접속 가능
- name: 로컬 관리자(Admin) 계정 생성
  community.mysql.mysql_user:
    name: dbadmin
    password: "{{ db_admin_password }}" #vault에서 이미 암호화 된 것을 가져와서 다른 사람이 보지 못 하게
    priv: '*.*:ALL,GRANT' # 모든 권한 부여 # 모든 테이블 , select권한을 주겠다 all은 모든 sql명령문을 쓸 수 있다 GRANT:허락한다
    host: 'localhost'      # [중요] 외부 접속 불가, 로컬 전용
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock  #임폴트할 때 쓰는 명령어

# [보안] 웹앱은 로컬호스트를 통해 DB 접속
- name: 웹(Web) 계정 생성
  community.mysql.mysql_user:
    name: webuser
    password: "{{ db_web_password }}"
    priv: 'employees.*:SELECT' # employees DB만 조회 가능 (최소 권한)  #테이블 컬럼 권한 순서 : 이번에는 select 권한만 줌 
    host: 'localhost'
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock   #계정 만들 때 쓰는 명령어
#tasks라서 못 넣음 주석처리 해야 에러 안 남 -> tasks 밖에서 써야 함 
#handlers: #이미 디렉토리에서 handlers 디렉토리 만들었으니까 hanlders파일 안에는 -name부터 시작
#  - name: restart mariadb
#    service:
#      name: mariadb
#      state: restarted

```

#### (3) Nginx Role (핵심: 8080 포트 개방)

웹 서버는 외부에 서비스를 제공해야 하므로 8080 포트를 열어둡니다.

**`roles/nginx/tasks/main.yml`**

```yaml
- name: Nginx 설치
  apt:
    name: nginx
    state: present

# AWS가 아니므로 OS 방화벽(UFW)에서 포트를 열어야 합니다. 웹서버라서 (특)
- name: 방화벽(UFW) - 8080 포트 외부 접속 허용
  community.general.ufw:
    rule: allow                    #파이어 월은 들어가는 인자(파라미터,argument라고도 함) 주는 게 argument,실제 값 쓰면 파라미터
    port: '8080'                   #소프트웨어는 모든지 포트로 감 80아닌 다른 포트번호로 쓸 때는 포트 번호를 써야 함 
    proto: tcp                       
- name: Nginx 설정 파일 배포
  #템플릿으로 conf파일 
  template:
    src: default.j2 
    dest: /etc/nginx/sites-available/default                # 웹서버만 webserver enable로 link 를 해줘야 진짜 서비스가 되는 것 (업데이트 에러?백 할 때 링크 끊으면 됨 그때 디폴트 아니고 백업 도메인 씀)
  notify: restart nginx                                     # default 안쓰고 jinie.com같은 거로 함 (디폴트 아닌 경우에는 웹서버가 무슨 서비스 할 지 모름 enable에 등록필) 수정식 사고나면 백하려고 2번 하게 만듦 (colab / gmail등 google.com에서도 여러 서비스를 하거나, 호스팅 사이트 같은 경우 여러개 도메인 서비스 가능)

#tasks니까 핸들러스 있으면 안됨 막아버려야 함
#handlers:
#  - name: restart nginx
#    service:
#      name: nginx
#      state: restarted

```

**`roles/nginx/templates/default.j2`**
템플릿 만들기

```nginx
server {
    # [중요] 8080 포트로 들어오는 모든 요청을 수신 #8080 또 있는지 헷갈려~ 호스트 인벤토리 지정할 때 그룹네임,호스트네임,그룹네임,디폴트 서버도 정할 수 있음 #우린 안 정함=맨 위의 아이피 가져가~
    listen 8080 default_server;    #;는 jinja문법(웹서버 conf파일 따라한거)
    server_name _;   #서버네임도 지정할 수 있음 없으면 디폴트=맨 위에 꺼 써!
    
    # 웹 루트 디렉토리 설정
    root /var/www/html; #이게 디폴트 설정
    index index.php index.html;  #html & php 로 이뤄졌으니까 준비해라 #url치면 제일 처음 루트디렉토리(홈디렉토리)로 감. index:제일 먼저 할 것(보통은 이걸로 시작하기로 약속함)

    location / {
        try_files $uri $uri/ =404;        #uri 파일을 찾아라 있는지 없는 지 -> 없으면 uri디렉토리(/) 있는지 찾아 그것도 없으면 404로 : 없는 페이지라는 브라우저와의 약속 #정해지지 않은 건 다 여기를 거쳐 #여기에 api 서버 넣으면 거기로 감 결제 등등 바꿀 수 있음
    }

    # PHP-FPM 연동 (Local Socket 방식)
    # Nginx와 PHP는 같은 서버 내에서 소켓 파일로 통신합니다.
    location ~ \.php$ {                                            #php에서 $약속하는 것
        include snippets/fastcgi-php.conf;                         #sinppet:짧은 코드 옛날에는 cgi를 썼음 사라지진 않았는데 느려서 fastcgi로 빠르게 쓸 수 있도록 한 것
        # Ubuntu 24.04의 기본 PHP 버전(8.3) 소켓 경로 확인 필요
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;               #php랑 접속 할 수 있게 소켓 정보 
    }
}

```

#### (4) WebApp Role

**`roles/webapp/tasks/main.yml`**

```yaml
- name: PHP 및 필수 모듈 설치
  apt:                                     #설치해라
    name:
      - php-fpm
      - php-mysql   # MySQL 연동 모듈 접속/끊을 때 /데이터와 명령 주고 받을 때
      - php-mbstring
    state: present

- name: index.php 소스 파일 배포
  template:                               #템플릿 쓸거야
    src: index.php.j2                     #index.php에서 가져올거야
    dest: /var/www/html/index.php         # 이 위치로
    owner: www-data # 웹 서버(Nginx)가 읽을 수 있는 권한
    group: www-data
    mode: '0644'    #4:읽기read(1,2,4)

```

**`roles/webapp/templates/index.php.j2`** #가져온다고 했으니까 있어야 함

```php
<?php
// [보안] DB는 127.0.0.1(localhost)에서만 응답하므로 호스트를 localhost로 지정
$host = 'localhost';     #호스트 변수=로컬 호스트
$user = 'webuser';       #유저 변수=웹유저
$pw = '{{ db_web_password }}'; // Vault에서 주입된 비밀번호     
$dbName = 'employees';   #mysql만들면 db여러개, 그 중 employees 쓰겠다

$mysqli = new mysqli($host, $user, $pw, $dbName);   #이 이름으로 접속해서 새 세션

if ($mysqli->connect_errno) {       #에러가 나면 이걸 처리해
    die("<div style='color:red'>DB 접속 실패: " . $mysqli->connect_error . "</div>");
}

$sql = "SELECT dept_no, dept_name FROM departments LIMIT 10";   #접속이 됐으면 sql변수에 이 변수 실행한 결과 저장해라 LIMIT:이 만큼만 10개만 FROM 테이블명:여기서 가져와
$result = $mysqli->query($sql);
?>
#여기까진 php언어라서 몰라도 됨
<!DOCTYPE html>
<html>
<head>
    <title>사내망 부서 정보 시스템</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 600px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #4CAF50; color: white; }        #css에서 정해둔 키:값 / style 시트 
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>                                                   #css
</head>
<body>
    <h1>🏢 Employees 부서 목록 (Local DB)</h1>
    <p>이 페이지는 외부(8080)에서 접속 가능하지만, DB는 내부에서만 통신합니다.</p>
    <table>
        <thead>
            <tr><th>부서 코드 (Dept No)</th><th>부서명 (Dept Name)</th></tr>
        </thead>
        <tbody>
            <?php while($row = $result->fetch_assoc()): ?>   #php명령어의 문법 row:한 줄 가져와(부서 번호, 부서 네임) , result는 줄 다 가지고 있음,  
            <tr>
                <td><?= $row['dept_no'] ?></td>
                <td><?= $row['dept_name'] ?></td>
            </tr>
            <?php endwhile; ?>
        </tbody>
    </table>
</body>
</html>

```

---

### 5. [Step 3] 통합 실행 (site.yml) #jinie_site.yml처럼 앞에 덧붙여서 이름 지어도 됨:0                   

**`site.yml`**

```yaml
- name: 온프레미스 보안 웹/DB 구축
  hosts: all
  become: yes # 모든 작업은 Root 권한(sudo)으로 수행
  vars_files:
    - group_vars/all/vault.yml
  roles:
    - common
    - mariadb
    - nginx
    - webapp

```

**실행 명령어:**

```bash
# Vault 비밀번호 입력을 요청하며 플레이북 실행
ansible-playbook -i inventory.ini site.yml --ask-vault-pass

```

---

### 요약 및 검증 포인트

1. **Nginx 접속:** 브라우저에서 `http://서버IP:8080`으로 접속하면 부서 목록이 표로 출력되어야 합니다.
2. **DB 보안 확인:**
* 외부 PC(DBeaver 등)에서 `서버IP:3306`으로 접속 시도 시 **접속 거부(Connection Refused)**가 발생해야 정상입니다. (bind-address가 막고 있음)
* 서버 내부 터미널에서 `mysql -u dbadmin -p`로 접속 시 정상 로그인되어야 합니다.


3. **데이터:** `employees` 데이터베이스에 데이터가 정상적으로 import 되었는지 페이지의 표 내용을 통해 확인합니다.

Next Step: **Gitea와 Jenkins를 연동한 CI/CD 파이프라인 구축**
