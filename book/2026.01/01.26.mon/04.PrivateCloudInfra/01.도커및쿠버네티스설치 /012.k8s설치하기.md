https://github.com/putto4u/04.PrivateCloudInfra/blob/main/01.%EB%8F%84%EC%BB%A4%EB%B0%8F%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4%EC%84%A4%EC%B9%98/012.k8s%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0.md


https://github.com/putto4u/04.PrivateCloudInfra/blob/main/01.%EB%8F%84%EC%BB%A4%EB%B0%8F%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4%EC%84%A4%EC%B9%98/012.k8s%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0.md
트러블슈팅 후 많이 바뀜 

쿠버네티스(Kubernetes, k8s)를 우분투 환경에서 **kubeadm**을 이용해 설치하는 상세 과정을 정리했습니다. 각 단계별로 명령어의 의미를 주석으로 달아두었습니다.

---

### 1. 시스템 환경 설정 (모든 노드 공통)

쿠버네티스가 정상적으로 컨테이너를 관리하기 위해 리눅스 시스템의 몇 가지 기본 설정을 변경해야 합니다.

```bash
# 1)시스템 패키지 업데이트
sudo apt update && sudo apt upgrade -y

#swap확인용(필수아님)
cd /etc
ls
sudo swapoff -a

# 2)Swap 메모리 비활성화 (k8s 스케줄러가 리소스를 정확히 계산하기 위해 필수)
sudo sed -i '/swap/s/^/#/' /etc/fstab # 재부팅 시에도 적용되도록 설정
cat fstab #재부팅할 때 fstab을 좀
```

swap왜 off? 잘 안쓰는 건 swap해버림, 자주 쓰는 걸 gpu주메모리 옆으로 swap해버림. swap보다 차라리 scale out 해야 성능이 좋아짐(쿠버네티스가 여유있다고 판단해버릴 수 있음)

```
# 3. 네트워크 브리지 모듈 로드 및 커널 파라미터 설정
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

#4-0
cd /etc/
cd sysctl.d/
ls #아직 k8s.conf가 없음 #이미지는 지우면 다 날라가니까 앤서블로 깔아도 됨 (참고로 한 번 init하면 두번 하면 안 됨)

# 4. iptables가 브리지된 트래픽을 볼 수 있도록 설정
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1        #쿠보네티스가 봄 (os는 아이피테이블을 보는 것 등록하면 os가 넘겨줌)     
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 브릿지 모드 볼 수 있게 해주는 것 아이피 테이블스는 리눅스에서 쓰는 os이므로, 가상의 네트워크 카드를 갖는 얘네를 알 수 없음
# 볼 수 있게 패킷 달아주는 것
# 설정 적용
sudo sysctl --system

```

### 2. 컨테이너 런타임(containerd) 설치

쿠버네티스는 컨테이너를 실행할 엔진이 필요합니다. 현재 표준인 **containerd**를 설치합니다.

```bash
# 1. Docker 저장소 등록을 위한 필수 패키지 설치
sudo apt install -y ca-certificates curl gnupg lsb-release #10도커설치에서 했으니까 생략

# 2. Docker 공식 GPG 키 추가  #이건 중복 하면 안 됨
sudo mkdir -p /etc/apt/keyrings 
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg 

# 3. Docker 저장소 추가 #이건 중복하면 안 됨
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. containerd 설치
sudo apt update
sudo apt install -y containerd.io

# 5. containerd 기본 설정 생성 및 Cgroup 관리자 설정 (Systemd 사용) 
cd /etc
sudo mkdir -p /etc/containerd   #containerd:컨테이너를 묶어서 카드를 만드는 그룹 관리라고 생각하면 됨
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

```

### 3. 쿠버네티스 구성 요소 설치 꼭 해야 함

클러스터 구축을 위한 핵심 도구 3인방(`kubeadm`, `kubelet`, `kubectl`)을 설치합니다. 큐브라고 부름 큐브어드민, 큐블렛,큐브컨트롤

```bash
# 1. 쿠버네티스 저장소의 GPG 키 다운로드 (v1.30 기준) 
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

#2-0
cd /etc/apt
ls
# 2. 쿠버네티스 apt 저장소 추가 #[절대 디렉토리] 써서 외부저장소 https:~에 넘겼음 
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

# 3. 도구 설치 및 버전 고정 (의도치 않은 업데이트 방지)
cd sources.list.d/
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl #apt-mark hold:버전 안 바꾸겠다

```

### 4. 마스터 노드(Control Plane) 초기화

이 단계는 **마스터로 사용할 서버에서만** 실행합니다.

```bash
cd /etc/apt/keyrings
# 1. 클러스터 초기화 (Flannel(네트워크잡는 드라이브) 네트워크를 사용할 경우 10.244.0.0/16 권장)
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# 2. 일반 사용자(root가 아닌)도 kubectl을 사용할 수 있도록 환경 변수 설정
mkdir -p $HOME/.kube
cd .kube #확인용
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

### 5. CNI(Container Network Interface) 설치

노드 간 통신을 위해 가상 네트워크 플러그인을 설치해야 노드 상태가 `Ready`로 변합니다.

```bash
# Flannel 네트워크 배포
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```

---

> [!IMPORTANT]
> **AWS 과금 주의**: 클라우드 환경에서 실습할 경우, 마스터 노드는 최소 **t3.medium**(2 CPU, 4GB RAM) 이상을 권장합니다. 프리티어인 t2.micro에서는 리소스 부족으로 설치가 실패할 수 있으며, 인스턴스 가동 시간에 따라 과금이 발생합니다.

Next Step: **워커 노드 연결 및 파드(Pod) 배포 테스트**

---
제시해주신 설치 과정은 **이미 한 번 실행된 환경에서 다시 실행(중복 실행)하면 충돌이 발생하거나 시스템 설정이 꼬일 위험이 큽니다.**

특히 쿠버네티스 초기화(`kubeadm init`)와 네트워크 설정 부분은 이전의 데이터가 남아있으면 에러를 뱉으며 중단됩니다. 만약 설치 중에 실수가 있었거나, 깨끗한 상태에서 다시 시작하고 싶다면 반드시 **초기화(Reset)** 과정을 거친 후 재설행해야 합니다.

---

### 재설치 또는 재실행 전 필수 단계: 클러스터 초기화

두 번 실행하기 전에, 먼저 기존에 생성된 인증서, 네트워크 인터페이스, 설정 파일들을 삭제해야 합니다.

```bash
# 1. 쿠버네티스 설정 초기화 (마스터/워커 노드 공통)
# 실행 시 [y/N] 질문이 나오면 y를 입력합니다.
sudo kubeadm reset

# 2. 개인 설정 디렉토리 삭제
rm -rf $HOME/.kube

# 3. CNI(네트워크 플러그인) 잔재 삭제
sudo rm -rf /etc/cni/net.d
sudo rm -rf /var/lib/cni/

# 4. (선택사항) IP 테이블 정리 (네트워크 꼬임 방지)
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

```

위 과정을 마친 후에 다시 단계별로 명령어를 실행하면 처음과 동일한 상태에서 깨끗하게 설치할 수 있습니다.

---

### 주의해야 할 중복 실행 항목

1. **`/etc/fstab` 수정 (Swap 비활성화)**: `sed` 명령어를 여러 번 실행하면 주석(`#`)이 중복해서 붙을 수 있습니다. 파일의 내용을 확인해 보세요.
2. **Containerd 설정**: `containerd config default` 명령어로 설정을 덮어쓰면 기존에 수정한 `SystemdCgroup = true` 설정이 초기화될 수 있으므로 주의가 필요합니다.
3. **Kubeadm Init**: 이미 클러스터가 생성된 상태에서 다시 실행하면 "이미 사용 중인 포트" 혹은 "파일이 이미 존재함" 에러가 발생합니다.

> [!CAUTION]
> **AWS 과금 관련**: 설치 실패 후 인스턴스를 종료하지 않고 방치하거나, 리소스 부족으로 인스턴스를 상위 등급(t3.medium 등)으로 새로 생성할 경우 **Elastic IP(공인 IP) 미연결 비용**이나 **EBS 볼륨 비용**이 누적되어 과금될 수 있으니 사용하지 않는 자원은 즉시 삭제하세요.

Next Step: **kubeadm reset 상세 옵션 및 트러블슈팅**


# 에러있어서 아예 싹~ 밀고 다시~~!

쿠버네티스 마스터 노드(Control Plane) 초기화 실패 후 디렉터리들을 삭제했다면, 단순히 kubeadm init만 다시 실행해서는 안 됩니다. 설정 잔재와 네트워크 인터페이스 상태가 꼬여 있을 가능성이 높기 때문에 완전한 초기화(Reset) 과정을 먼저 거쳐야 합니다.

쿠버네티스 노드 재설정 및 재초기화 가이드
etcd 데이터와 CNI 설정 파일을 삭제한 것은 클러스터의 상태 정보와 네트워크 구성을 모두 날린 것이므로, 깨끗한 상태에서 다시 시작하는 것이 가장 안전합니다.

1. 노드 초기화 (kubeadm reset)
가장 먼저 수행해야 할 단계입니다. 삭제되지 않은 나머지 설정값과 실행 중인 컨테이너들을 정리합니다.

sudo kubeadm reset
주의: 실행 중 /etc/kubernetes/ 내의 설정 파일들이 삭제된다는 안내가 나옵니다. y를 눌러 진행하세요.
2. 잔류 데이터 및 네트워크 인터페이스 정리
수동으로 지우셨던 디렉터리들을 포함하여, 확실한 초기화를 위해 아래 명령어를 차례로 실행합니다. 특히 cni 인터페이스가 남아 있으면 재설치 시 네트워크 충돌이 발생할 수 있습니다.

# CNI 설정 및 바이너리 삭제
sudo rm -rf /etc/cni/net.d
sudo rm -rf /var/lib/cni/

# etcd 데이터 삭제 (이미 삭제하셨다면 확인만 하세요)
sudo rm -rf /var/lib/etcd

# 쿠버네티스 설정 디렉터리 삭제
sudo rm -rf ~/.kube
sudo rm -rf /etc/kubernetes/
3. IPVS/IPTables 및 네트워크 인터페이스 초기화
이전에 생성되었던 가상 네트워크 인터페이스(cni0, flannel.1 등)를 제거해야 합니다.

# 네트워크 인터페이스 초기화
sudo ip link delete cni0
sudo ip link delete flannel.1

# iptables 설정 초기화
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X
4. kubeadm init 재시도
이제 다시 마스터 노드를 초기화할 준비가 되었습니다. Pod 네트워크 대역(CIDR) 설정을 포함하여 초기화를 진행합니다.

# 예시: Flannel을 사용할 경우 --pod-network-cidr를 지정해야 합니다.
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
5. 후속 작업 (관리 권한 부여)
초기화가 완료되면 출력되는 가이드를 따라 일반 사용자가 kubectl을 사용할 수 있도록 설정합니다.

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
6. CNI(네트워크 플러그인) 재설치
cni/net.d를 지웠기 때문에, 노드 상태가 NotReady로 보일 것입니다. 사용하고자 하는 네트워크 플러그인(Calico, Flannel 등)을 다시 설치해야 합니다.

질문하신 삭제 부분에 대한 검토
/var/lib/etcd 삭제: 클러스터의 모든 상태 정보(Pod, Service, ConfigMap 등)가 들어있는 DB입니다. 처음부터 다시 클러스터를 구성하는 상황이라면 삭제해도 무방하며, 오히려 찌꺼기가 남지 않아 재설치 시 오류를 방지합니다.
cni/net.d 및 lib/cni 삭제: 네트워크 구성 파일입니다. 재설치 시 CNI 플러그인 YAML을 다시 배포하면 자동으로 생성되므로 걱정하지 않으셔도 됩니다.
Next Step:
kubeadm init 실패 원인 파악, etcd 데이터 복구 방법, CNI 플러그인 선택 가이드

AWS 관련 참고: 만약 AWS EC2 위에서 직접 마스터를 구성 중이라면, 보안 그룹(Security Group)에서 6443, 2379-2380, 10250, 10259, 10257 포트가 열려 있는지 반드시 확인하세요. AWS 관리형 서비스인 EKS를 사용 중이라면 이러한 수동 초기화 방식은 권장되지 않습니다.
