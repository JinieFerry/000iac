디렉토리를 꼭 안 만들어도 괜찮음    

파일 이름만 엔서블로 정한 것.   

Ansible 배포 **플레이북(Playbook)** 제작 방법에 대해 간단한 예제 시나리오를 통해 설명해 드리겠습니다. 이 플레이북은 웹 서버에 파일을 배포하고 서비스를 재시작하는 IaC(Infrastructure as Code)의 기본 형태입니다.

-----

## 1\. 플레이북 제작 준비: 목표 및 환경 정의

### 1.1. 목표 시나리오

**웹 서버 그룹**에 새로운 **HTML 인덱스 파일**을 배포하고, 변경 사항 적용을 위해 **Nginx 서비스**를 재시작하는 작업을 자동화합니다.

### 1.2. 파일 구조 준비

Ansible 제어 노드에 다음과 같은 디렉토리와 파일을 준비합니다.

```
~/project/iac/ansible/
├── inventory.ini      # 관리 대상 서버 정의
├── deploy_web.yml     # 메인 플레이북 파일
└── files/
    └── index.html     # 배포할 파일
```

### 1.3. 인벤토리 파일 (`inventory.ini`) 작성

관리 대상 서버의 그룹과 접속 정보를 정의합니다.

```ini
[webservers]
# 실제 AWS/클라우드 서버의 IP 주소 또는 호스트명을 입력합니다.
web_server_1 ansible_host=192.168.1.10
web_server_2 ansible_host=192.168.1.11

[all:vars]
# 모든 호스트에 적용될 변수 (ssh 접속 계정)
ansible_user=ubuntu
```

-----

## 2\. 배포 플레이북 (`deploy_web.yml`) 작성

플레이북은 **YAML** 형식으로 작성되며, 작업의 순서와 대상을 정의합니다.

```yaml
---
# 플레이북 이름 정의
- name: Deploy new index.html and restart Nginx
  hosts: webservers          # 인벤토리의 'webservers' 그룹 대상
  become: yes                # 루트 권한(sudo)으로 작업 수행
  
  tasks:
    # Task 1: Nginx 설치 확인 (선택 사항이지만 일관성을 위해 권장)
    - name: Ensure Nginx is installed
      ansible.builtin.apt:
        name: nginx
        state: present

    # Task 2: 새로운 index.html 파일 배포
    - name: Copy new index.html to web root
      ansible.builtin.copy:
        src: files/index.html   # 제어 노드의 files/index.html
        dest: /var/www/html/index.nginx-debian.html # 대상 서버의 Nginx 기본 경로
        owner: www-data
        group: www-data
        mode: '0644'
      # 파일이 변경되었을 때만 'restart nginx' 핸들러를 호출하도록 지정
      notify: restart nginx

    # Task 3: Nginx 서비스가 실행 중인지 확인
    - name: Ensure Nginx service is running
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

  # Handlers: notify에 의해서만 실행되는 작업들 (멱등성 확보에 중요)
  handlers:
    - name: restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
```

### 💡 주요 요소 설명

1.  **`hosts: webservers`**: 이 작업이 실행될 대상을 지정합니다.
2.  **`become: yes`**: 관리자 권한(`sudo`)이 필요한 작업을 위해 설정합니다.
3.  **`tasks:`**: 실제 수행할 작업 목록입니다.
      * **`ansible.builtin.copy`**: 제어 노드의 파일을 대상 서버로 복사하는 모듈입니다.
      * **`notify: restart nginx`**: 이 작업(파일 복사)이 **실제로 변경 사항을 만들었을 때만** `handlers` 섹션의 `restart nginx`를 호출하도록 합니다. 이것이 Ansible **멱등성**의 핵심입니다.
4.  **`handlers:`**: `tasks`에서 `notify`가 호출되었을 때만 실행되는 작업입니다. 서비스 재시작처럼 비용이 드는 작업은 변경이 있을 때만 실행하여 효율을 높입니다.

-----



## 3\. 플레이북 실행 및 자동화

준비된 파일과 플레이북을 사용하여 배포를 실행합니다.

```bash
# Ansible 실행 명령어
ansible-playbook -i inventory.ini deploy_web.yml
```

### 📌 실행 결과의 의미 (IaC의 실현)

  * **첫 번째 실행**: Nginx가 설치되고, `index.html`이 복사되며, Nginx가 재시작됩니다.
  * **두 번째 실행 (파일 변경 없음)**: Ansible은 Nginx가 이미 설치되어 있고, `index.html` 파일의 내용도 변경되지 않았음을 감지합니다. 따라서 **Nginx 재시작 작업은 건너뛰고** 모든 태스크가 `ok` 상태로 완료됩니다.
  * **세 번째 실행 (파일 변경 후)**: `files/index.html`을 수정한 후 실행하면, `Task 2`에서 변경이 감지되어 `changed` 상태가 되고, **`handlers`가 호출되어** Nginx가 재시작됩니다.

이처럼 Ansible 플레이북을 사용하면 사람이 수동으로 할 때 발생할 수 있는 실수를 방지하고, 인프라의 상태를 코드로 정의하고 일관되게 유지하는 \*\*인프라 자동화(IaC)\*\*를 구현할 수 있습니다.
