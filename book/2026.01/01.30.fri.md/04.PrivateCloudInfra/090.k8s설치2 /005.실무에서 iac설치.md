### 0. 어디까지 설치했는지 확인하기
`which kubelet` # kubelet이 있는지 
`find /` #루트부터 찾기
---

## 쿠버네티스 v1.30.14 클러스터 구축 최종 실무 프로세스

실무에서는 **'인프라의 상태를 코드로 관리(IaC)'**하기 위해 모든 설정값을 YAML 파일에 명시하고, 이를 통해 클러스터의 일관성을 유지합니다.

### 1. 구축 공정 목차

1. **[사전 설정]** 커널 모듈 및 네트워크 파라미터 최적화 (모든 노드)
2. **[런타임 준비]** Containerd 설치 및 Cgroup Driver 설정 (모든 노드)
3. **[도구 설치]** K8s v1.30.14 패키지 설치 및 고정 (모든 노드)
4. **[설계]** `v1beta4` 기반 마스터 노드 설정 파일(YAML) 생성 및 수정
5. **[구축]** YAML 기반 마스터 노드 초기화 및 관리자 환경 설정
6. **[네트워크]** 파드 간 통신을 위한 CNI(Calico) 배포
7. **[확장]** Join Token을 이용한 워커 노드 연결 및 최종 검증

---

### 2. 단계별 실행 가이드

#### 1단계: OS 환경 최적화 (모든 노드)

os는 물리적으로 있는 것들 만 처리하게 만들었음, 그래서 가상의 것들 까지 같이 처리하도록 overlay 명령

쿠버네티스가 노드 간 네트워크 패킷을 정상적으로 라우팅할 수 있도록 설정합니다.

```bash
# 스왑 비활성화 및 영구 적용
sudo swapoff -a && sudo sed -i '/swap/s/^/#/' /etc/fstab

# 커널 모듈 로드 (네트워크 브릿지 및 오버레이)
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
#os가 가상의 것들 까지 같이 처리 할 수 있도록 overlay 명령
overlay
#브릿지까지 같이 os가 처리하도록
br_netfilter
EOF
#커널 명령어: conf파일 보고 실제로 처리해라
sudo modprobe overlay && sudo modprobe br_netfilter

# 네트워크 파라미터 설정 (L3 포워딩 활성화)
#cat은 뿌리는 것:vi로 작성해서 카피하는 것과 같음
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
#브릿지 모드로 생기는 것들
#아이피 4자리도 처리하도록 true (=1)
net.bridge.bridge-nf-call-iptables  = 1
#아이피 8자리도 처리하도록 true (=1)
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
#시스템에 적용
sudo sysctl --system

```

#### 2단계: 컨테이너 런타임(Containerd) 최적화 (모든 노드)

런타임 설치 후, 쿠버네티스와의 OS 관리 방식(systemd)을 일치시키는 작업이 필수입니다.

```bash
sudo apt-get update && sudo apt-get install -y containerd

# 기본 설정 생성 및 SystemdCgroup 활성화 수정
# shell명령어로 봄
sudo mkdir -p /etc/containerd # 최종 실행은 컨테이너가 해서 containerd가 함
containerd config default | sudo tee /etc/containerd/config.toml
#sed: shell edit 쉘명령어로 편집하겠다는 명령어 : 자주 사용함
# s/~~~ = s:교체,  /: 검색, ~~~검색할 내용, =true/: true로 교체하겠다, g: 글 마지막까지
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

```
```
#vmmaster1에서 수정하기
cat /etc/containerd/config.toml
```
#### 3단계: K8s 도구 설치 (모든 노드)

질문하신 **v1.30.14** 버전을 명시하여 설치합니다.

```bash
# 레포지토리 설정 후 버전 명시하여 설치
sudo apt-get install -y kubelet=1.30.14-1.1 kubeadm=1.30.14-1.1 kubectl=1.30.14-1.1
sudo apt-mark hold kubelet kubeadm kubectl

```

### 1단계~3단계 까지는 하나의 yaml 파일로도 만들 수 있음

#### 4단계: `v1beta4` 기반 설계도 작성 (마스터 노드)

설치 전, 현재 버전에 맞는 최신 템플릿을 추출하고 수정합니다.

```bash
kubeadm config print init-defaults --component-configs KubeletConfiguration > kubeadm-init.yaml  #yaml 파일 만드는 것 , 실행 아님
# vi kubeadm-init.yaml 실행하여 아래 핵심 내용 수정
# 1. advertiseAddress: 마스터IP  #마스터 노드 control p 아이피 바꿀 수 있음
# 2. kubernetesVersion: 1.30.14
# 3. podSubnet: 10.244.0.0/16
# 4. cgroupDriver: systemd (KubeletConfiguration 섹션)

```

#### 5단계: 마스터 노드 가동 및 관리 권한 부여 (마스터 노드)

```bash
# 선언형 구축 실행
sudo kubeadm init --config kubeadm-init.yaml  #위에서 만든 yaml 불러서 선언형으로 실행

# 관리자(kubectl) 권한 설정 (이 작업이 빠지면 kubectl 명령이 작동하지 않음)
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

#### 6단계: 파드 네트워크(CNI) 배포 (마스터 노드)

노드 상태를 `Ready`로 만들고 파드 간 통신을 활성화합니다.

```bash
# Calico CNI 설치 (실무 표준 중 하나)
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml  

```

#### 7단계: 워커 노드 조인 및 상태 확인

```bash
# 워커 노드에서 마스터가 발행한 조인 토큰 실행
sudo kubeadm join 192.168.1.10:6443 --token ...  # 토큰 만들어서 주면 워커 노드에서 join

# 마스터에서 노드 상태 최종 확인
kubectl get nodes

```

---

### 💡 실전 팁: 누락되기 쉬운 포인트

* **Firewall:** 실무에서는 `ufw`나 `iptables`에서 6443(API Server), 2379-2380(ETCD) 등의 포트가 열려 있는지 반드시 체크해야 합니다.
* **CRI-Socket:** 여러 런타임이 설치된 경우 `kubeadm init` 시 어떤 소켓을 사용할지 YAML에 명확히 명시해야 충돌이 없습니다.

---

요청하신 대로 전후 필수 처리 과정을 모두 포함하여 v1.30.14 기준의 최종 교재용 가이드를 완성했습니다.

## Next Step: 쿠버네티스 대시보드(Dashboard) 및 메트릭 서버 구축

