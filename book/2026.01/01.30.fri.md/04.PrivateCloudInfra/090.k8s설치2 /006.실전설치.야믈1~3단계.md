ë„¤, í˜„ì¬ í…Œë¼í¼ì´ ì—†ëŠ” í™˜ê²½ì´ë¼ë©´ **Ansible(ì•¤ì„œë¸”)**ì„ ì‚¬ìš©í•˜ì—¬ 1ë‹¨ê³„(OS ìµœì í™”)ë¶€í„° 3ë‹¨ê³„(K8s ë„êµ¬ ì„¤ì¹˜)ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ **YAML í”Œë ˆì´ë¶**ìœ¼ë¡œ ë¬¶ì–´ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì™„ë²½í•œ ì‹¤ë¬´í˜• IaC ë°©ì‹ì…ë‹ˆë‹¤.

ê°•ì‚¬ë‹˜ì˜ ë§ˆìŠ¤í„° PCì—ì„œ ìˆ˜ê°•ìƒ PC(ì˜ˆë¹„ ì„œë²„)ë“¤ì„ ëŒ€ìƒìœ¼ë¡œ í•œ ë²ˆì— ì„¤ì •ì„ ë°€ì–´ ë„£ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¡œ êµ¬ì„±í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---
005.ì‹¤ë¬´ì—ì„œ iacì„¤ì¹˜.mdì—ì„œì˜ 1,2,3ë‹¨ê³„ë¥¼ yamlë¡œ ë§Œë“œëŠ” ê²ƒ   

ë³€ìˆ˜ê°’ ë“¤ì„ í‚¤ì™€ ê°’ì˜ ëŒ€ì¹­ìœ¼ë¡œ ë”°ë¡œ ëŒ€ì¹­ìœ¼ë¡œ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŒ, ëˆ„êµ¬í•œí…Œ í• ê±´ì§€, ë¬´ìŠ¨ ì¼ì„ í•  ê²ƒì¸ì§€ í¬ê²Œ 3ê°€ì§€ í•¨. ë§ˆí¬ì—… ë­ê·€ì§€ ì •ì˜í•˜ëŠ” ê²ƒì´ yaml. (ë²„ì „ì„ ë„£ì–´ì£¼ì§€ëŠ” ì•ŠìŒ)       
ì—”ì„œë¸”ì€ ëŒ€ìƒê³¼ ì¼ì„ ì •ì˜      

### ì»¤ë§¨ë“œì™€ ì‰˜ì˜ ì°¨ì´
ì»¤ë§¨ë“œ: ë°”ì´ë„ˆë¦¬= í•˜ë‚˜ì˜ ì¼ë§Œ: ì˜µì…˜ë§Œ ìˆê³  ë³€ìˆ˜ë¥¼ ë°›ì•„ ì˜¬ ìˆ˜ëŠ” ì—†ìŒ: ë‹¨ìˆœ ëª…ë ¹ì¼ ë•Œ          
ì‰˜: ëª…ë ¹ì–´ë¡œ í•œ ì¤„ ì§œë¦¬ í”„ë¡œê·¸ë¨í™” í•  ìˆ˜ ìˆìŒ + í™˜ê²½ ë³€ìˆ˜ë¥¼ ì“¸ ìˆ˜ ìˆìŒ: ì´ì–´ì§ˆ ë•Œ     

## 0. k8s_install ë””ë ‰í† ë¦¬ í•˜ë‚˜ ë”°ë¡œ ë§Œë“¤ê¸°
```
cd k8s_install/
vi hosts.ini
```
## 1. Ansibleì„ ì´ìš©í•œ OS ë° K8s í™˜ê²½ ì¤€ë¹„ (1~3ë‹¨ê³„ í†µí•©)

ì´ YAML íŒŒì¼ì€ ê° ì„œë²„ì— ì ‘ì†í•˜ì—¬ ìŠ¤ì™‘ í•´ì œ, ì»¤ë„ ì„¤ì •, ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ë° K8s ë„êµ¬ ì„¤ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### [ì„¤ê³„] k8s_setup_playbook.yaml ìƒì„±

```
#ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd k8s_install
#yaml íŒŒì¼ ë§Œë“¤ê¸° ì•„ë˜ ê¸´ ì½”ë“œ ë³µë¶™
vi k8s_setup_playbook.yaml
```
##### k8s_setup_playbook.yaml íŒŒì¼ì— ë¶™ì—¬ë„£ì„ ì½”ë“œ

```yaml
---
- name: Kubernetes OS ë° í™˜ê²½ ìµœì í™” (1~3ë‹¨ê³„)
  hosts: all
  become: yes
  tasks:
    # 1ë‹¨ê³„: OS ì„¤ì •
    # ë¬´ìŠ¨ ì¼ì„ í•˜ëŠ”ì§€ ë‹¤ìŒ ì‚¬ëŒì´ ì•Œ ìˆ˜ ìˆë„ë¡ ë„¤ì„ì— ì¨ ë‘  (ê¼­ ì•ˆ ì³ë„ ë˜ê³  ìˆ˜ì •ë§Œ í•´ë„ ë¨) 
    - name: ìŠ¤ì™‘(Swap) ë©”ëª¨ë¦¬ ë¹„í™œì„±í™”
      shell: |
        swapoff -a
        sed -i '/swap/s/^/#/' /etc/fstab
    #05.ì‹¤iì„¤ì—ì„œì˜ 1ë‹¨ê³„ osí™˜ê²½ ìµœì í™” ì—­í• 
    - name: ì»¤ë„ ëª¨ë“ˆ ë¡œë“œ ì„¤ì •
      # ì»¨ì²¸ì¸ ë¥¼ ì¹´í”¼í•´ì˜´
      copy:
        #ì¹´í”¼ í•´ ì˜¬ ìœ„ì¹˜
        dest: /etc/modules-load.d/k8s.conf  
        content: |
          overlay
          br_netfilter

    - name: ì»¤ë„ ëª¨ë“ˆ ì¦‰ì‹œ ë¡œë“œ
      modprobe:
        name: "{{ item }}"
        #ë¡œë“œ í•œ ìƒíƒœ ìœ ì§€: ì•ˆëìœ¼ë©´ í•˜ê³ , ëìœ¼ë©´ ë„˜ì–´ê°€~
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: ì»¤ë„ íŒŒë¼ë¯¸í„°(sysctl) ì„¤ì •
      # ë©”ë‰´ì–¼ì— ë‚˜ì™€ìˆìŒ (linux ì‚¬ì´íŠ¸)
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/k8s.con
      #yamlì€ ë¦¬ìŠ¤íŠ¸ë¡œ í‚¤ì™€ê°’ì´ ìˆìŒ. ë¦¬ìŠ¤íŠ¸ í•˜ë‚˜ ë” ì¶”ê°€ í•œ ê²ƒ, ë¦¬ìŠ¤íŠ¸ëŠ” í•œ ì¤„ ì”© ì‹¤í–‰í•¨
      #ì½¤ë§ˆë¥¼ í†µí•´ì„œ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë‘ ê°€ì§€ ê°’:nameê³¼ value ì‚¬ìš©
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }

    # 2ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„(Containerd) ì„¤ì¹˜
    - name: Containerd ì„¤ì¹˜ ë° ì„¤ì •
    # ëª¨ë“ˆ ë“¤ì€ ì²˜ë¦¬ í•  ê²ƒì„ ë‘ ì¹¸ ì”© ë“¤ì—¬ì„œ ì”€ (ë„¤ ì¹¸ë„ ê°€ëŠ¥í•˜ì§€ë§Œ ê°€ì‹œì„± ë–¨ì–´ì§)
      apt:
        name: containerd
        state: present
        update_cache: yes

    - name: Containerd ê¸°ë³¸ ì„¤ì • ìƒì„± ë° SystemdCgroup í™œì„±í™”
      # 05.ì‹¤iì„¤ì˜ 2ë‹¨ê³„ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ shell ëª…ë ¹ì–´ë¥¼ sudo ë¹¼ê³  ê·¸ëŒ€ë¡œ ì¹œ ê²ƒê³¼ ê°™ìŒ
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
      #ì¬ì ìš© í•  ë•Œ ì•„ë˜ì˜ handlersë‘ ì—°ê²° ë¨
      notify: restart containerd

    # 3ë‹¨ê³„: K8s ë„êµ¬(v1.30.14) ì„¤ì¹˜
    - name: K8s ê³µì‹ ë ˆí¬ì§€í† ë¦¬ í‚¤ ë° ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
      shell: |
        # curl:ë‹¤ìš´ë¡œë“œ ì‹œìŠ¤í…œ ê´€ë¦¬ ì‹œ ìì£¼ ì“°ëŠ” ëª…ë ¹ì–´
        # ìš°ë¶„íˆ¬ì—ì„œëŠ” /ë¥¼ ë‘ê°œ ì”€ (ì˜µì…˜ê³¼ í—·ê°ˆë¦¬ì§€ ì•Šê¸° ìœ„í•´ì„œ), f:fail
        # curl -? ëª…ë ¹ì–´ë¥¼ í†µí•´ì„œ curl ëª…ë ¹ì–´ì— ëŒ€í•´ì„œ ì„¤ëª… ë³¼ ìˆ˜ ìˆìŒ, s:silent ë¡œê·¸ ë½‘ì§€ ë§ˆë¼
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

    - name: K8s v1.30.14 ë„êµ¬ ì„¤ì¹˜
      apt:
        name:
          - kubelet=1.30.14-1.1
          - kubeadm=1.30.14-1.1
          - kubectl=1.30.14-1.1
        state: present
        update_cache: yes

    - name: ë²„ì „ ì—…ë°ì´íŠ¸ ê³ ì •
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: [kubelet, kubeadm, kubectl]
  # ìœ„ì˜ notihyê°€ ì¬ì ìš© ë  ë•Œ
  handlers:
    - name: restart containerd
      service:
        name: containerd
        state: restarted

```
ì €ì¥í•˜ê³  ë‚˜ì˜¤ê¸° `wq!`

---


## 2. ì‹¤í–‰ ë°©ë²•

ë§ˆìŠ¤í„° PC(ë˜ëŠ” ê°•ì‚¬ë‹˜ PC)ì—ì„œ ì•¤ì„œë¸”ì„ í†µí•´ ëŒ€ìƒ ì„œë²„ë“¤ì—ê²Œ ëª…ë ¹ì„ ë‚´ë¦½ë‹ˆë‹¤.

### â‘  ì¸ë²¤í† ë¦¬(hosts) íŒŒì¼ ì‘ì„±

ëŒ€ìƒ ì„œë²„ë“¤ì˜ IPë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
# hosts.ini íŒŒì¼ ìƒì„± : ìê¸° ì•„ì´í”¼ ë„£ê¸°
[k8s_nodes]
192.168.115.251  # ë§ˆìŠ¤í„° í›„ë³´
192.168.115.1  # ì›Œì»¤ í›„ë³´
192.168.115.2  # ì›Œì»¤ í›„ë³´

```

ê²°ê³¼í™•ì¸
```
master@vmmaster1:~$ cd k8s_install
master@vmmaster1:~/k8s_install$ ls
master@vmmaster1:~/k8s_install$ vi hosts.ini
master@vmmaster1:~/k8s_install$ vi hosts.ini
master@vmmaster1:~/k8s_install$ cat hosts.ini 
[k8s_nodes]
192.168.115.251  # ë§ˆìŠ¤í„° í›„ë³´
#192.168.115.1  # ì›Œì»¤ í›„ë³´ ì¼ë‹¨ ë§‰ì•„ë‘ê¸°
#192.168.115.2  # ì›Œì»¤ í›„ë³´ ì¼ë‹¨ ë§‰ì•„ë‘ê¸°
```

### â‘¡ í”Œë ˆì´ë¶ ì‹¤í–‰

```bash

# ì•¤ì„œë¸” ì‹¤í–‰ ëª…ë ¹ì–´
#ansible-playbook -i hosts.ini k8s_setup_playbook.yaml -u <ì‚¬ìš©ìê³„ì •> --become-password-confirm
#--become-password-confirm ì—ëŸ¬ë‚˜ì„œ ì½”ë“œ ìˆ˜ì •
ansible-playbook -i hosts.ini k8s_setup_playbook.yaml -u master --ask-become-pass
#ë¹„ì»´íŒ¨ìŠ¤ì›Œë“œ : 1234

# ì•ˆë˜ë©´ -Kì˜µì…˜

```
sshë˜ëŠ” ë””ë ‰í† ë¦¬ë¼ë¦¬ íŒŒì¼ í†µì§¸ë¡œ ë³´ë‚´ê¸°
```
scp -r ./k8s_install master@192.168.115.1:/home/master/
```
---

## 3. ì‹¤í–‰ í›„ ë‹¨ê³„ (4ë‹¨ê³„~5ë‹¨ê³„)

ìœ„ì˜ ì•¤ì„œë¸” ì‘ì—…ì´ ëë‚˜ë©´ ëª¨ë“  ì„œë²„ëŠ” `kubeadm` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ì¤€ë¹„ê°€ ì™„ë£Œëœ ìƒíƒœì…ë‹ˆë‹¤. ì´í›„ë¶€í„°ëŠ” ì•ì„œ ì •ë¦¬í•œ ê²ƒì²˜ëŸ¼ **ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ** ì§ì ‘ `kubeadm init --config kubeadm-init.yaml`ì„ ì‹¤í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

---

### ğŸ’¡ ì‹¤ë¬´ì íŒ: ì™œ ì´ë ‡ê²Œ í•˜ë‚˜ìš”?

* **ì¼ê´€ì„±:** 20ëŒ€, 100ëŒ€ì˜ ì„œë²„ê°€ ìˆë”ë¼ë„ ë‹¨ í•œ ë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë‘ **ë™ì¼í•œ ì»¤ë„ ì„¤ì •ê³¼ ë™ì¼í•œ ë²„ì „**ì„ ê°–ê²Œ ë©ë‹ˆë‹¤.
* **ë³µêµ¬ë ¥:** ìƒˆë¡œìš´ ì„œë²„ë¥¼ ì¶”ê°€í•´ì•¼ í•  ë•Œ, ì´ í”Œë ˆì´ë¶ì— IPë§Œ ì¶”ê°€í•˜ê³  ì‹¤í–‰í•˜ë©´ ì¦‰ì‹œ í´ëŸ¬ìŠ¤í„° ì°¸ì—¬ ì¤€ë¹„ê°€ ëë‚©ë‹ˆë‹¤.

Next Step: Ansibleë¡œ ìƒì„±ëœ ì„œë²„ë“¤ ì¤‘ í•œ ê³³ì—ì„œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™” ìˆ˜í–‰í•˜ê¸°

---

ì•¤ì„œë¸”ì„ í™œìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ ì™¸ë¶€ ì¸í”„ë¼ ë ˆì´ì–´ë¥¼ YAMLë¡œ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ êµ¬ì„±í•´ ë“œë ¸ìŠµë‹ˆë‹¤.

Next Step: ì•¤ì„œë¸”ë¡œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”(`kubeadm init`)ê¹Œì§€ ì™„ì „íˆ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¼ê¹Œìš”?
